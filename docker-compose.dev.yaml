services:
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile
      args:
        REVIVE_VERSION: "6.0.5"
    container_name: revive-adserver-dev-app
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      memcached:
        condition: service_started
    ports:
      - "8082:80"
    volumes:
      - revive_images_dev:/var/www/html/www/images
      - revive_delivery_dev:/var/www/html/www/delivery
      - revive_var_dev:/var/www/html/var
      - mysql_socket_dev:/run/mysqld

  mysql:
    image: mysql:8.0
    container_name: revive-adserver-dev-db
    restart: unless-stopped
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
      MYSQL_ROOT_HOST: "%"
      MYSQL_DATABASE: revive
      MYSQL_USER: revive
      MYSQL_PASSWORD: revive_pass
    volumes:
      - mysql_data_dev:/var/lib/mysql
      - mysql_socket_dev:/run/mysqld
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot --silent"]
      interval: 10s
      timeout: 5s
      retries: 7
      start_period: 30s

  memcached:
    image: memcached:1.6-alpine
    container_name: revive-adserver-dev-memcached
    restart: unless-stopped
    command: ["memcached", "-m", "128", "-p", "11211", "-u", "memcache"]

volumes:
  mysql_data_dev:
  mysql_socket_dev:
  revive_images_dev:
  revive_delivery_dev:
  revive_var_dev:
